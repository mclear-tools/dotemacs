;; Project Management
;; This project workflow primarily uses a single frame with
;; different workspaces, made possible by projectile and eyebrowse.
;; See also https://raw.githubusercontent.com/seagle0128/.emacs.d/master/lisp/init-persp.el


;;; Projectile
(use-package projectile
  :ensure t
  :hook (after-init . projectile-mode)
  :init
  ;; save projectile-known-projects-file in cache folder
  (setq projectile-known-projects-file
        (concat cpm-cache-dir "projectile-bookmarks.eld"))
  (setq projectile-cache-file
        (concat cpm-cache-dir "projectile.cache"))
  (setq projectile-enable-caching t
        projectile-files-cache-expire 60)
  :config
  ;; Use the faster searcher to handle project files: ripgrep `rg'.
  (when (and (not (executable-find "fd"))
             (executable-find "rg"))
    (setq projectile-generic-command
          (let ((rg-cmd ""))
            (dolist (dir projectile-globally-ignored-directories)
              (setq rg-cmd (format "%s --glob '!%s'" rg-cmd dir)))
            (concat "rg -0 --files --color=never --hidden" rg-cmd))))
  (setq projectile-git-submodule-command nil))

;;; Eyebrowse
(use-package eyebrowse
  :commands (eyebrowse-mode
             eyebrowse-create-window-config
             eyebrowse-switch-to-window-config-1
             eyebrowse-switch-to-window-config-2)
  :init
  (setq eyebrowse-keymap-prefix (kbd "C-c C-b"))
  :hook (after-init . eyebrowse-mode)
  :config
  (setq eyebrowse-new-workspace t
        eyebrowse-mode-line-style 'hide
        eyebrowse-wrap-around t
        eyebrowse-switch-back-and-forth t))

;;; Perspectives
;; I use this to isolate buffers in the different eyebrowse workspaces
(use-package persp-mode
  :ensure t
  :hook (after-init . persp-mode)
  :commands (get-current-persp
             persp-contain-buffer-p
             persp-mode
             persp-switch
             persp-next
             persp-prev
             persp-add-buffer
             persp-rename
             persp-kill)
  :general
  (:states '(insert normal motion emacs)
   :keymaps 'override
   "s-p" 'persp-switch
   "s-]" 'persp-next
   "s-[" 'persp-prev)
  :config
  (setq persp-add-buffer-on-after-change-major-mode t
        persp-nil-name "default"
        persp-set-last-persp-for-new-frames nil
        persp-kill-foreign-buffer-behaviour 'kill
        persp-auto-resume-time -1
        persp-autokill-buffer-on-remove 'kill-weak
        persp-save-dir (expand-file-name "persp-confs/" cpm-cache-dir)
        persp-common-buffer-filter-functions
        (list #'(lambda (b)
                  "Ignore temporary buffers."
                  (or (string-prefix-p " " (buffer-name b))
                      (and (string-prefix-p "*" (buffer-name b))
                           (not (string-equal "*scratch*" (buffer-name b))))
                      (string-prefix-p "magit" (buffer-name b))
                      (string-prefix-p "Pfuture-Callback" (buffer-name b))
                      (eq (buffer-local-value 'major-mode b) 'nov-mode)
                      (eq (buffer-local-value 'major-mode b) 'vterm-mode)))))
  ;; fix for (void-function make-persp-internal) error
  ;; NOTE: Redefine `persp-add-new' to address.
  ;; Issue: Unable to create/handle persp-mode
  ;; https://github.com/Bad-ptr/persp-mode.el/issues/96
  ;; https://github.com/Bad-ptr/persp-mode-projectile-bridge.el/issues/4
  ;; https://emacs-china.org/t/topic/6416/7
  (defun* persp-add-new (name &optional (phash *persp-hash*))
    "Create a new perspective with the given `NAME'. Add it to `PHASH'.
   Return the created perspective."
    (interactive "sA name for the new perspective: ")
    (if (and name (not (equal "" name)))
        (destructuring-bind (e . p)
            (persp-by-name-and-exists name phash)
          (if e p
            (setq p (if (equal persp-nil-name name)
                        nil (make-persp :name name)))
            (persp-add p phash)
            (run-hook-with-args 'persp-created-functions p phash)
            p))
      (message "[persp-mode] Error: Can't create a perspective with empty name.")
      nil))

  ;; Integrate Ivy
  ;; https://gist.github.com/Bad-ptr/1aca1ec54c3bdb2ee80996eb2b68ad2d#file-persp-ivy-el
  (with-eval-after-load 'ivy
    (add-to-list 'ivy-ignore-buffers
                 #'(lambda (b)
                     (when persp-mode
                       (let ((persp (get-current-persp)))
                         (if persp
                             (not (persp-contain-buffer-p b persp))
                           nil)))))))
  ;; (add-hook 'persp-switch-hook 'cpm/eyebrowse-persp-switch))


;; work with projectile
(use-package persp-mode-projectile-bridge
  :ensure t
  :after projectile
  :functions (persp-add-new
              persp-add-buffer
              set-persp-parameter)
  :commands (persp-mode-projectile-bridge-find-perspectives-for-all-buffers
             persp-mode-projectile-bridge-kill-perspectives
             persp-mode-projectile-bridge-add-new-persp
             projectile-project-buffers)
  :hook ((persp-mode . persp-mode-projectile-bridge-mode)
         (persp-mode-projectile-bridge-mode
          .
          (lambda ()
            (if persp-mode-projectile-bridge-mode
                (persp-mode-projectile-bridge-find-perspectives-for-all-buffers)
              (persp-mode-projectile-bridge-kill-perspectives))))))

;;; Project Functions
;;;; Eyebrowse & Perspectives
;; courtesy of spacemacs
;; Eyebrowse - allow perspective-local eyebrowse workspaces --------------------------

(defun cpm/load-eyebrowse-for-perspective (&optional frame)
  "Load an eyebrowse workspace according to a perspective's parameters.
 FRAME's perspective is the perspective that is considered, defaulting to
 the current frame's perspective.
 If the perspective doesn't have a workspace, create one."
  (let* ((persp (get-frame-persp frame))
         (window-configs (persp-parameter 'eyebrowse-window-configs persp))
         (current-slot (persp-parameter 'eyebrowse-current-slot persp))
         (last-slot (persp-parameter 'eyebrowse-last-slot persp)))
    (if window-configs
        (progn
          (eyebrowse--set 'window-configs window-configs frame)
          (eyebrowse--set 'current-slot current-slot frame)
          (eyebrowse--set 'last-slot last-slot frame)
          (eyebrowse--load-window-config current-slot))
      (eyebrowse--set 'window-configs nil frame)
      (eyebrowse-init frame)
      (cpm/save-eyebrowse-for-perspective frame))))

(defun cpm/update-eyebrowse-for-perspective (_new-persp-name name)
  "Update and save current frame's eyebrowse workspace to its perspective.
 Parameter _NEW-PERSP-NAME is ignored, and exists only for compatibility with
 `persp-before-switch-functions'."
  (eyebrowse--update-window-config-element
   (eyebrowse--current-window-config (eyebrowse--get 'current-slot)
                                     (eyebrowse--get 'current-tag)))
  (cpm/save-eyebrowse-for-perspective))

(defun cpm/save-eyebrowse-for-perspective (&optional frame)
  "Save FRAME's eyebrowse workspace to FRAME's perspective.
 FRAME defaults to the current frame."
  (let ((persp (get-current-persp    frame)))
    (set-persp-parameter
     'eyebrowse-window-configs (eyebrowse--get 'window-configs frame) persp)
    (set-persp-parameter
     'eyebrowse-current-slot (eyebrowse--get 'current-slot frame) persp)
    (set-persp-parameter
     'eyebrowse-last-slot (eyebrowse--get 'last-slot frame) persp)))

(defun cpm-layouts/post-init-eyebrowse ()
  (add-hook 'persp-before-switch-functions #'cpm/update-eyebrowse-for-perspective)
  (add-hook 'eyebrowse-post-window-switch-hook #'cpm/save-eyebrowse-for-perspective)
  (add-hook 'persp-activated-functions #'cpm/load-eyebrowse-for-perspective))


;;; Old Project Functions
;; ;;;; Switch Eyebrowse after Change of Perspective
;; (defun cpm/eyebrowse-persp-switch ()
;;   "set eyebrowse when switching perspectives"
;;   (interactive)
;;   (let* ((persp-name (persp-name CL-X))
;;          (eyebrowse-switch-to-window-config persp-name))))

;; ;;;; Open agenda as Workspace
;; (defun cpm/open-agenda-in-workspace ()
;;   "open agenda in its own workspace"
;;   (interactive)
;;   ;; (eyebrowse-mode)
;;   ;; (eyebrowse-switch-to-window-config-1)
;;   (persp-switch "agenda")
;;   (setq frame-title-format '("" "%b"))
;;   (require 'org-super-agenda)
;;   (cpm/jump-to-org-super-agenda)
;;   ;; (eyebrowse-rename-window-config (eyebrowse--get 'current-slot) "agenda")
;;   (persp-add-buffer "*Org Agenda*"))

;; (general-define-key
;;  :states '(insert normal motion emacs)
;;  :keymaps 'override
;;  "s-1" 'cpm/open-agenda-in-workspace)

;; ;;;; Open emacs.d in workspace
;; (defun cpm/open-emacsd-in-workspace ()
;;   "open emacsd in workspace"
;;   (interactive)
;;   ;; (eyebrowse-mode)
;;   ;; (eyebrowse-switch-to-window-config-2)
;;   (persp-switch "emacs.d")
;;   (setq frame-title-format
;;         '(""
;;           "%b"
;;           (:eval
;;            (let ((project-name (projectile-project-name)))
;;              (unless (string= "-" project-name)
;;                (format " in [%s]" project-name))))))
;;   (require 'crux)
;;   (crux-find-user-init-file)
;;   ;; (eyebrowse-rename-window-config (eyebrowse--get 'current-slot) "emacs.d")
;;   (require 'magit)
;;   (magit-status-setup-buffer))

;; (general-define-key
;;  :states '(insert normal motion emacs)
;;  :keymaps 'override
;;  "s-2" 'cpm/open-emacsd-in-workspace)


;;;; Open New Project in Workspace
(defun cpm/open-project-and-workspace ()
  "open a new project as its own workspace -- i.e. in its own perspective and eyebrowse slot"
  (interactive)
  ;; (eyebrowse-create-window-config)
  (counsel-projectile-switch-project)
  (setq frame-title-format
        '(""
          "%b"
          (:eval
           (let ((project-name (projectile-project-name)))
             (unless (string= "-" project-name)
               (format " in [%s]" project-name))))))
  (persp-switch (projectile-project-name))
  (require 'magit)
  (magit-status-setup-buffer))

;;;; Open a Project in a New Frame
(defun cpm/open-project-and-frame ()
  (interactive)
  (let ((buffer (generate-new-buffer "untitled")))
    (set-buffer-major-mode buffer)
    (display-buffer buffer '(display-buffer-pop-up-frame . nil)))
  (crux-create-scratch-buffer)
  (counsel-projectile-switch-project)
  (toggle-frame-maximized)
  (setq frame-title-format
        '(""
          "%b"
          (:eval
           (let ((project-name (projectile-project-name)))
             (unless (string= "-" project-name)
               (format " in [%s]" project-name))))))
  (split-window-right)
  (require 'magit)
  (magit-status-setup-buffer))

;;; Spacemacs Layouts
;; https://github.com/yanghaoxie/emacs.d#workspaces
(use-package spacemacs-persp-extra
  :ensure nil
  :after (:all persp-mode eyebrowse)
  :demand t
  :load-path (lambda () (concat cpm-elisp-dir "spacemacs-persp-extra/"))
  :commands (spacemacs/update-eyebrowse-for-perspective
             spacemacs/save-eyebrowse-for-perspective
             spacemacs/load-eyebrowse-for-perspective
             spacemacs/load-eyebrowse-for-perspective)
  :general
  (:keymaps 'override
   :states '(normal visual motion)
   "g M-0" 'spacemacs/persp-switch-to-0
   "g M-1" 'spacemacs/persp-switch-to-1
   "g M-2" 'spacemacs/persp-switch-to-2
   "g M-3" 'spacemacs/persp-switch-to-3
   "g M-4" 'spacemacs/persp-switch-to-4
   "g M-5" 'spacemacs/persp-switch-to-5
   "g M-6" 'spacemacs/persp-switch-to-6
   "g M-7" 'spacemacs/persp-switch-to-7
   "g M-8" 'spacemacs/persp-switch-to-8
   "g M-9" 'spacemacs/persp-switch-to-9
   "g M-l" 'spacemacs/jump-to-last-layout
   "g M-c" 'spacemacs/layouts-ts-close)
  (cpm/leader-keys
   "l" 'hydra-persp/body)
  :init
  (add-hook 'persp-before-switch-functions
            #'spacemacs/update-eyebrowse-for-perspective)
  (add-hook 'eyebrowse-post-window-switch-hook
            #'spacemacs/save-eyebrowse-for-perspective)
  (add-hook 'persp-activated-functions
            #'spacemacs/load-eyebrowse-for-perspective)
  (add-hook 'persp-before-save-state-to-file-functions
            #'spacemacs/update-eyebrowse-for-perspective)
  (add-hook 'persp-after-load-state-functions
            #'spacemacs/load-eyebrowse-after-loading-layout)
  (setq dotspacemacs-auto-generate-layout-names t
        dotspacemacs-default-layout-name "default")
  :config
  (defadvice persp-activate (before spacemacs//save-toggle-layout activate)
    (setq spacemacs--last-selected-layout persp-last-persp-name))
  (add-hook 'persp-mode-hook 'spacemacs//layout-autosave)
  (add-hook 'persp-created-functions
            #'spacemacs//add-project-buffers-to-persp)
  (advice-add 'persp-load-state-from-file :before 'spacemacs//layout-wait-for-modeline))
(defhydra hydra-persp (:hint nil)
  "
 Go to^^^^^^                                  Actions^^
 [_0_.._9_]^^     nth/new layout              [_a_]^^   add buffer
 [_C-0_.._C-9_]^^ nth/new layout              [_A_]^^   add all from layout
 [_<tab>_]^^^^    last layout                 [_d_]^^   close current layout
 [_b_]^^^^        buffer in layout            [_D_]^^   close other layout
 [_h_]^^^^        default layout              [_L_]^^   load layouts from file
 [_l_]^^^^        layout w/helm/ivy           [_r_]^^   remove current buffer
 [_n_/_C-l_]^^    next layout                 [_R_]^^   rename current layout
 [_N_/_p_/_C-h_]  prev layout                 [_s_/_S_] save all layouts/save by names
 [_o_]^^^^        custom layout               [_t_]^^   show a buffer without adding it to current layout
 [_w_]^^^^        workspaces transient state  [_x_]^^   kill current w/buffers
 ^^^^^^                                       [_X_]^^   kill other w/buffers
 ^^^^^^                                       [_<_/_>_] move layout left/right
 ^^^^^^                                       "
  ("1" spacemacs/persp-switch-to-1 :exit t)
  ("2" spacemacs/persp-switch-to-2 :exit t)
  ("3" spacemacs/persp-switch-to-3 :exit t)
  ("4" spacemacs/persp-switch-to-4 :exit t)
  ("5" spacemacs/persp-switch-to-5 :exit t)
  ("6" spacemacs/persp-switch-to-6 :exit t)
  ("7" spacemacs/persp-switch-to-7 :exit t)
  ("8" spacemacs/persp-switch-to-8 :exit t)
  ("9" spacemacs/persp-switch-to-9 :exit t)
  ("0" spacemacs/persp-switch-to-0 :exit t)
  ("C-1" spacemacs/persp-switch-to-1)
  ("C-2" spacemacs/persp-switch-to-2)
  ("C-3" spacemacs/persp-switch-to-3)
  ("C-4" spacemacs/persp-switch-to-4)
  ("C-5" spacemacs/persp-switch-to-5)
  ("C-6" spacemacs/persp-switch-to-6)
  ("C-7" spacemacs/persp-switch-to-7)
  ("C-8" spacemacs/persp-switch-to-8)
  ("C-9" spacemacs/persp-switch-to-9)
  ("C-0" spacemacs/persp-switch-to-0)
  ("<tab>" spacemacs/jump-to-last-layout)
  ("<return>" nil :exit t)
  ("TAB" spacemacs/jump-to-last-layout)
  ("RET" nil :exit t)
  ("C-h" persp-prev)
  ("C-l" persp-next)
  ("<" spacemacs/move-current-persp-left)
  (">" spacemacs/move-current-persp-right)
  ("a" persp-add-buffer :exit t)
  ("A" persp-import-buffers :exit t)
  ("b" spacemacs/persp-buffers :exit t)
  ("d" spacemacs/layouts-ts-close)
  ("D" spacemacs/layouts-ts-close-other :exit t)
  ("h" spacemacs/layout-goto-default :exit t)
  ("L" persp-load-state-from-file :exit t)
  ("l" persp-switch :exit t)
  ("n" persp-next)
  ("N" persp-prev)
  ("o" spacemacs/select-custom-layout :exit t)
  ("p" persp-prev)
  ("r" persp-remove-buffer :exit t)
  ("R" spacemacs/layouts-ts-rename :exit t)
  ("s" persp-save-state-to-file :exit t)
  ("S" persp-save-to-file-by-names :exit t)
  ("t" persp-temporarily-display-buffer :exit t)
  ("w" hydra-eyebrowse/body :exit t)
  ("x" spacemacs/layouts-ts-kill)
  ("X" spacemacs/layouts-ts-kill-other :exit t)
  ("q" nil))


;;; Bookmarks
(use-package bookmark
  :defer 2
  :config
  (setq bookmark-default-file (concat cpm-cache-dir "bookmarks")))

(use-package bookmark+
  :commands (bmkp-switch-bookmark-file-create bmkp-set-desktop-bookmark)
  :config
  (setq bmkp-last-as-first-bookmark-file (concat cpm-cache-dir "bookmarks")))

;;; Org and Projectile
(use-package org-projectile
  :ensure t
  :defer 3
  :config
  (setq org-projectile-projects-file "~/Dropbox/org-files/projects.org"))

(use-package org-projectile-helm
  :ensure t
  :after org-projectile)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; (provide 'setup-projects)
